import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,o as a,d as n}from"./app-DqlpKXpH.js";const l={},e=n(`<h1 id="nginx安装web应用防火墙" tabindex="-1"><a class="header-anchor" href="#nginx安装web应用防火墙"><span>Nginx安装Web应用防火墙</span></a></h1><p>LNMP一键安装包 ngx_lua_waf waf(web应用防火墙) 安装设置。WAF中文名是Web应用防火墙，WAF能够根据规则拦截SQL注入、恶意请求、黑客扫描等HTTP请求从而保护WEB应用的安全。</p><p>今天我们要说的是一个比较简单好用的基于lua的waf：ngx_lua_waf。它是一个基于lua-nginx-module(openresty)的web应用防火墙，https://github.com/loveshell/ngx_lua_waf。</p><p>用途：</p><ul><li>防止sql注入，本地包含，部分溢出，fuzzing测试，xss，SSRF等web攻击</li><li>防止svn/备份之类文件泄漏</li><li>防止ApacheBench之类压力测试工具的攻击</li><li>屏蔽常见的扫描黑客工具，扫描器</li><li>屏蔽异常的网络请求</li><li>屏蔽图片附件类目录php执行权限</li><li>防止webshell上传</li></ul><h2 id="ngx-lua-waf安装" tabindex="-1"><a class="header-anchor" href="#ngx-lua-waf安装"><span>ngx_lua_waf安装</span></a></h2><h3 id="_1-lua支持安装" tabindex="-1"><a class="header-anchor" href="#_1-lua支持安装"><span>1. lua支持安装</span></a></h3><p>LNMP一键安装包从1.5开始增加了lua支持的选项，可以通过修改lnmp.conf中Enable_Nginx_Lua后的参数为 y 来启用lua，如果没安装lnmp，修改lnmp.conf后保存，安装完lnmp就是支持lua的，如果已经安装好lnmp，也是按前面修改lnmp.conf</p><p>然后lnmp安装包目录下运行<code>./upgrade.sh nginx</code> 升级nginx</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>./upgrade.sh nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>输入当前nginx版本号或更新的nginx版本号，升级完成就是支持lua的了。如果出错，请重新下载完整版的LNMP安装包lnmp**-full.tar.gz，再次安装。</p><h3 id="_2-安装ngx-lua-waf" tabindex="-1"><a class="header-anchor" href="#_2-安装ngx-lua-waf"><span>2. 安装ngx_lua_waf</span></a></h3><p>下载安装ngx_lua_waf：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>wget https://github.com/loveshell/ngx_lua_waf/archive/master.zip -O ngx_lua_waf.zip</span></span>
<span class="line"><span>unzip ngx_lua_waf.zip</span></span>
<span class="line"><span>mv ngx_lua_waf-master /usr/local/nginx/conf/waf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>nginx上设置并启用ngx_lua_waf</p><p>编辑 <code>/usr/local/nginx/conf/nginx.conf </code>在<strong>http段</strong>的 <code>server_tokens off</code>; 下面添加如下代码：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>lua_package_path &quot;/usr/local/nginx/conf/waf/?.lua&quot;;</span></span>
<span class="line"><span>lua_shared_dict limit 10m;</span></span>
<span class="line"><span>init_by_lua_file /usr/local/nginx/conf/waf/init.lua;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改完成保存</p><p>如果要想在某个虚拟主机启用ngx_lua_waf可以修改对应虚拟主机的server段，在该server段中 root 网站目录行下面添加如下代码：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>access_by_lua_file /usr/local/nginx/conf/waf/waf.lua;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>修改完成保存</p><p>测试nginx配置文件：<code>/usr/local/nginx/sbin/nginx -t</code> 重载nginx配置生效：<code>/usr/local/nginx/sbin/nginx -s reload</code></p><p>如果测试和重载都没报错就已经生效。</p><p>可以通过访问 http://域名/test.php?id=../etc/passwd 来测试</p><p>提示：您的请求带有&gt;不合法参数，已被网站管理员设置拦截！说明已经正确设置</p><h3 id="_3-ngx-lua-waf防火墙配置" tabindex="-1"><a class="header-anchor" href="#_3-ngx-lua-waf防火墙配置"><span>3. ngx_lua_waf防火墙配置</span></a></h3><p>ngx_lua_waf配置文件位置：<code>/usr/local/nginx/conf/waf/config.lua</code> ngx_lua_waf配置文件参数说明：</p><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" data-title="lua" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">RulePath</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> “</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">usr</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">nginx</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">conf</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">waf</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">wafconf</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–规则存放目录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">attacklog</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> “</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">off</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–是否开启攻击信息记录，需要配置logdir</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">logdir</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> “</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">usr</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">nginx</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">logs</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">hack</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–log存储目录，该目录需要用户自己新建，切需要nginx用户的可写权限</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">UrlDeny</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–是否拦截url访问</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">Redirect</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–是否拦截后重定向</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CookieMatch</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> “</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–是否拦截cookie攻击</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">postMatch</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> “</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–是否拦截post攻击</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">whiteModule</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> “</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–是否开启URL白名单</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">black_fileExt</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{“</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">php</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”,”</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">jsp</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–填写不允许上传文件后缀类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">ipWhitelist</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{“</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">127.0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.0.1”}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–ip白名单，多个ip用逗号分隔</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">ipBlocklist</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{“</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.0.1″}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–ip黑名单，多个ip用逗号分隔</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CCDeny</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–是否开启拦截cc攻击(需要nginx.conf的http段增加lua_shared_dict </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">m;)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CCrate</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> “</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">60</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–设置cc攻击频率，单位为秒.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–默认1分钟同一个IP只能请求同一个地址100次</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">html</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">[[Please go away~~]] </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">–警告内容,可在中括号内自定义</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>备注:不要乱动双引号，区分大小写</p><p>ngx_lua_waf安装到此结束。</p><h3 id="_4-ngx-lua-waf效果图" tabindex="-1"><a class="header-anchor" href="#_4-ngx-lua-waf效果图"><span>4. ngx_lua_waf效果图</span></a></h3><p><img src="https://cdn.jsdelivr.net/gh/jiange1236/MyImage/MdImg/ngcb15.jpg" alt="ngx_lua_waf waf(web应用防火墙)" loading="lazy"><img src="https://cdn.jsdelivr.net/gh/jiange1236/MyImage/MdImg/ngcb15-16419157753881.jpg" alt="ngx_lua_waf waf(web应用防火墙)" loading="lazy"></p>`,32),t=[e];function h(p,k){return a(),s("div",null,t)}const g=i(l,[["render",h],["__file","Nginx安装Web应用防火墙.html.vue"]]),c=JSON.parse('{"path":"/others/Nginx%E5%AE%89%E8%A3%85Web%E5%BA%94%E7%94%A8%E9%98%B2%E7%81%AB%E5%A2%99.html","title":"Nginx安装Web应用防火墙","lang":"zh-CN","frontmatter":{"author":"jiange1236","title":"Nginx安装Web应用防火墙","description":"Nginx安装Web应用防火墙","date":"2022-01-15T00:00:00.000Z","category":"other","tag":"other","article":true,"timeline":true,"icon":null,"password":null,"head":[["meta",{"property":"og:url","content":"https://zecdn.top/others/Nginx%E5%AE%89%E8%A3%85Web%E5%BA%94%E7%94%A8%E9%98%B2%E7%81%AB%E5%A2%99.html"}],["meta",{"property":"og:site_name","content":"Zeblog"}],["meta",{"property":"og:title","content":"Nginx安装Web应用防火墙"}],["meta",{"property":"og:description","content":"Nginx安装Web应用防火墙"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://cdn.jsdelivr.net/gh/jiange1236/MyImage/MdImg/ngcb15.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-06-07T05:03:50.000Z"}],["meta",{"property":"article:author","content":"jiange1236"}],["meta",{"property":"article:tag","content":"other"}],["meta",{"property":"article:published_time","content":"2022-01-15T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-06-07T05:03:50.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Nginx安装Web应用防火墙\\",\\"image\\":[\\"https://cdn.jsdelivr.net/gh/jiange1236/MyImage/MdImg/ngcb15.jpg\\",\\"https://cdn.jsdelivr.net/gh/jiange1236/MyImage/MdImg/ngcb15-16419157753881.jpg\\"],\\"datePublished\\":\\"2022-01-15T00:00:00.000Z\\",\\"dateModified\\":\\"2024-06-07T05:03:50.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"jiange1236\\"}]}"],["link",{"rel":"alternate","type":"application/atom+xml","href":"https://zecdn.top/atom.xml","title":"Zeblog Atom Feed"}],["link",{"rel":"alternate","type":"application/json","href":"https://zecdn.top/feed.json","title":"Zeblog JSON Feed"}],["link",{"rel":"alternate","type":"application/rss+xml","href":"https://zecdn.top/rss.xml","title":"Zeblog RSS Feed"}]]},"headers":[{"level":2,"title":"ngx_lua_waf安装","slug":"ngx-lua-waf安装","link":"#ngx-lua-waf安装","children":[{"level":3,"title":"1. lua支持安装","slug":"_1-lua支持安装","link":"#_1-lua支持安装","children":[]},{"level":3,"title":"2. 安装ngx_lua_waf","slug":"_2-安装ngx-lua-waf","link":"#_2-安装ngx-lua-waf","children":[]},{"level":3,"title":"3. ngx_lua_waf防火墙配置","slug":"_3-ngx-lua-waf防火墙配置","link":"#_3-ngx-lua-waf防火墙配置","children":[]},{"level":3,"title":"4. ngx_lua_waf效果图","slug":"_4-ngx-lua-waf效果图","link":"#_4-ngx-lua-waf效果图","children":[]}]}],"git":{"createdTime":1652425305000,"updatedTime":1717736630000,"contributors":[{"name":"jiange1236","email":"183465355@qq.com","commits":4},{"name":"周子健","email":"183465355@qq.com","commits":2}]},"readingTime":{"minutes":2.93,"words":880},"filePathRelative":"others/Nginx安装Web应用防火墙.md","localizedDate":"2022年1月15日","excerpt":""}');export{g as comp,c as data};
